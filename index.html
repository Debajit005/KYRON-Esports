<!DOCTYPE html>
<html>
<head>
  <title>Kyron Esports ‚Äì Leaderboards</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="stylesIndex.css">
</head>
<body>
  <button onclick="location.href='admin-gate.html'" style="
    padding: 8px 14px;
    margin-bottom: 15px;
    cursor: pointer;
  ">
    üîê Admin Login
  </button>

<div class="section">
  <h2>üåç Global Leaderboard</h2>
  <p>Average performance across all matches</p>

  <table>
    <thead>
      <tr>
          <th>#</th>
        <th>Player (UID)</th>
        <th>Matches Played</th>
        <th>Avg Rank Points</th>
      </tr>
    </thead>
    <tbody id="leaderboard"></tbody>
  </table>
</div>



<div class="section">
  <h2>üéÆ Match-wise Leaderboards</h2>
  <div id="matchLeaderboards"></div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDfzeLVOtRFWXozN4jKX9DfrrWjVFIGyuw",
  authDomain: "kyron-esports.firebaseapp.com",
  projectId: "kyron-esports",
  storageBucket: "kyron-esports.firebasestorage.app",
  messagingSenderId: "688589391933",
  appId: "1:688589391933:web:798e96fef9694af816c254",
  measurementId: "G-TK64VD9RP9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= GLOBAL LEADERBOARD =================
const leaderboardBody = document.getElementById("leaderboard");
const players = {};

const matchesSnap = await getDocs(collection(db, "matches"));

for (const matchDoc of matchesSnap.docs) {
  const regSnap = await getDocs(
    collection(db, "matches", matchDoc.id, "registrations")
  );

  regSnap.forEach(docSnap => {
    const p = docSnap.data();
    if (!p.uid) return;

    if (!players[p.uid]) {
      players[p.uid] = {
        uid: p.uid,
        name: p.name,
        totalPoints: 0,
        matches: 0
      };
    }

    players[p.uid].totalPoints += Number(p.rankPoints || 0);
    players[p.uid].matches += 1;
  });
}

const ranked = Object.values(players)
  .map(p => ({ ...p, avgPoints: p.totalPoints / p.matches }))
  .sort((a, b) => b.avgPoints - a.avgPoints);

leaderboardBody.innerHTML = "";
ranked.forEach((p, i) => {
  const rankClass =
    i === 0 ? "rank-1" :
    i === 1 ? "rank-2" :
    i === 2 ? "rank-3" : "";

  leaderboardBody.innerHTML += `
    <tr class="${rankClass}">
      <td>#${i + 1}</td>
      <td>
        <strong>${p.name}</strong><br>
        <small>UID: ${p.uid}</small>
      </td>
      <td>${p.matches}</td>
      <td>${p.avgPoints.toFixed(3)}</td>
    </tr>
  `;
});


// ================= MATCH-WISE LEADERBOARDS =================
const matchContainer = document.getElementById("matchLeaderboards");

const matchesQuery = query(
  collection(db, "matches"),
  orderBy("date", "desc")
);

const orderedMatchesSnap = await getDocs(matchesQuery);

for (const matchDoc of orderedMatchesSnap.docs) {
  const m = matchDoc.data();

  const regSnap = await getDocs(
    collection(db, "matches", matchDoc.id, "registrations")
  );

const playersArr = [];

regSnap.forEach(docSnap => {
  playersArr.push(docSnap.data());
});

// sort by rankPoints DESC
playersArr.sort((a, b) => (b.rankPoints || 0) - (a.rankPoints || 0));

let rows = "";

playersArr.forEach((p, i) => {
  rows += `
    <tr>
      <td>#${i + 1}</td>
      <td>${p.name}</td>
      <td>${p.rankPoints || 0}</td>
      <td>${p.kills || 0}</td>
      <td>${p.damage || 0}</td>
      <td>${p.knockdowns || 0}</td>
    </tr>
  `;
});


let dateStr = "Unknown";

if (m.date) {
  let d;

  if (typeof m.date.toDate === "function") {
    d = m.date.toDate();           // Firestore Timestamp
  } else if (typeof m.date === "number") {
    d = new Date(m.date);          // milliseconds
  } else if (typeof m.date === "string") {
    d = new Date(m.date);          // string date
  }

  if (d && !isNaN(d)) {
    const day = String(d.getDate()).padStart(2, "0");
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const year = d.getFullYear();

    dateStr = `${day}/${month}/${year}`;
  }
}



  matchContainer.innerHTML += `
    <h3>${m.matchName || "Unnamed Match"}</h3>
    <p>
      <strong>Game:</strong> ${m.game || "-"} |
      <strong>Mode:</strong> ${m.mode || "-"}<br>
      <small>Date: ${dateStr}</small>
    </p>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Rank Points</th>
          <th>Kills</th>
          <th>Damage</th>
          <th>Knockdowns</th>
        </tr>
      </thead>
      <tbody>
        ${rows || "<tr><td colspan='6'>No data</td></tr>"}
      </tbody>
    </table>
  `;
}
</script>

</body>
</html>
